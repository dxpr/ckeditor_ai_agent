!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CKEditor5=t():(e.CKEditor5=e.CKEditor5||{},e.CKEditor5.aiagent=t())}(self,(()=>(()=>{var e={"./node_modules/sbd/lib/Match.js":(e,t)=>{var n,o=["al","adj","assn","Ave","BSc","MSc","Cell","Ch","Co","cc","Corp","Dem","Dept","ed","eg","Eq","Eqs","est","est","etc","Ex","ext","Fig","fig","Figs","figs","i.e","ie","Inc","inc","Jan","Feb","Mar","Apr","Jun","Jul","Aug","Sep","Sept","Oct","Nov","Dec","jr","mi","Miss","Mrs","Mr","Ms","Mol","mt","mts","no","Nos","PhD","MD","BA","MA","MM","pl","pop","pp","Prof","Dr","pt","Ref","Refs","Rep","repr","rev","Sec","Secs","Sgt","Col","Gen","Rep","Sen","Gov","Lt","Maj","Capt","St","Sr","sr","Jr","jr","Rev","Sun","Mon","Tu","Tue","Tues","Wed","Th","Thu","Thur","Thurs","Fri","Sat","trans","Univ","Viz","Vol","vs","v"];t.setAbbreviations=function(e){n=e||o};var i=t.isCapitalized=function(e){return/^[A-Z][a-z].*/.test(e)||s(e)};t.isSentenceStarter=function(e){return i(e)||/``|"|'/.test(e.substring(0,2))},t.isCommonAbbreviation=function(e){var t=e.replace(/[-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/]/gi,"");return~n.indexOf(t)},t.isTimeAbbreviation=function(e,t){if(("a.m."===e||"p.m."===e)&&"day"===t.replace(/\W+/g,"").slice(-3).toLowerCase())return!0;return!1},t.isDottedAbbreviation=function(e){var t=e.replace(/[\(\)\[\]\{\}]/g,"").match(/(.\.)*/);return t&&t[0].length>0},t.isCustomAbbreviation=function(e){return e.length<=3||i(e)},t.isNameAbbreviation=function(e,t){return t.length>0&&(!!(e<5&&t[0].length<6&&i(t[0]))||t.filter((function(e){return/[A-Z]/.test(e.charAt(0))})).length>=3)};var s=t.isNumber=function(e,t){return t&&(e=e.slice(t-1,t+2)),!isNaN(e)};t.isPhoneNr=function(e){return e.match(/^(?:(?:\+?1\s*(?:[.-]\s*)?)?(?:\(\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9])\s*\)|([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\s*(?:[.-]\s*)?)?([2-9]1[02-9]|[2-9][02-9]1|[2-9][02-9]{2})\s*(?:[.-]\s*)?([0-9]{4})(?:\s*(?:#|x\.?|ext\.?|extension)\s*(\d+))?$/)},t.isURL=function(e){return e.match(/[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/)},t.isConcatenated=function(e){var t=0;if(((t=e.indexOf("."))>-1||(t=e.indexOf("!"))>-1||(t=e.indexOf("?"))>-1)&&e.charAt(t+1).match(/[a-zA-Z].*/))return[e.slice(0,t),e.slice(t+1)];return!1},t.isBoundaryChar=function(e){return"."===e||"!"===e||"?"===e}},"./node_modules/sbd/lib/sanitize-html-browser.js":e=>{e.exports=function(e,t){if(("string"==typeof e||e instanceof String)&&"undefined"!=typeof document){var n=document.createElement("DIV");n.innerHTML=e,e=(n.textContent||"").trim()}else"object"==typeof e&&e.textContent&&(e=(e.textContent||"").trim());return e}},"./node_modules/sbd/lib/stringHelper.js":(e,t)=>{t.endsWithChar=function(e,t){return t.length>1?t.indexOf(e.slice(-1))>-1:e.slice(-1)===t},t.endsWith=function(e,t){return e.slice(e.length-t.length)===t}},"./node_modules/sbd/lib/tokenizer.js":(e,t,n)=>{var o=n("./node_modules/sbd/lib/sanitize-html-browser.js"),i=n("./node_modules/sbd/lib/stringHelper.js"),s=n("./node_modules/sbd/lib/Match.js"),r=" @~@ ",a=r.trim(),l=new RegExp("\\S",""),c=new RegExp("\\n+|[-#=_+*]{4,}","g"),d=new RegExp("\\S+|\\n","g");t.sentences=function(e,t){if(!e||"string"!=typeof e||!e.length)return[];if(!l.test(e))return[];var n,u,m={newline_boundaries:!1,html_boundaries:!1,html_boundaries_tags:["p","div","ul","ol"],sanitize:!1,allowed_tags:!1,preserve_whitespace:!1,abbreviations:null};if("boolean"==typeof t)m.newline_boundaries=!0;else for(var h in t)m[h]=t[h];if(s.setAbbreviations(m.abbreviations),m.newline_boundaries&&(e=e.replace(c,r)),m.html_boundaries){var p="(<br\\s*\\/?>|<\\/("+m.html_boundaries_tags.join("|")+")>)",g=new RegExp(p,"g");e=e.replace(g,"$1"+r)}(m.sanitize||m.allowed_tags)&&(m.allowed_tags||(m.allowed_tags=[""]),e=o(e,{allowedTags:m.allowed_tags}));var f=0,v=0,w=[],E=[],b=[];if(!(n=m.preserve_whitespace?(u=e.split(/(<br\s*\/?>|\S+|\n+)/)).filter((function(e,t){return t%2})):e.trim().match(d))||!n.length)return[];for(var T=0,y=n.length;T<y;T++)if(f++,b.push(n[T]),~n[T].indexOf(",")&&(f=0),s.isBoundaryChar(n[T])||i.endsWithChar(n[T],"?!")||n[T]===a)(m.newline_boundaries||m.html_boundaries)&&n[T]===a&&b.pop(),E.push(b),f=0,b=[];else if((i.endsWithChar(n[T],'"')||i.endsWithChar(n[T],"”"))&&(n[T]=n[T].slice(0,-1)),i.endsWithChar(n[T],".")){if(T+1<y){if(2===n[T].length&&isNaN(n[T].charAt(0)))continue;if(s.isCommonAbbreviation(n[T]))continue;if(s.isSentenceStarter(n[T+1])){if(s.isTimeAbbreviation(n[T],n[T+1]))continue;if(s.isNameAbbreviation(f,n.slice(T,6)))continue;if(s.isNumber(n[T+1])&&s.isCustomAbbreviation(n[T]))continue}else{if(i.endsWith(n[T],".."))continue;if(s.isDottedAbbreviation(n[T]))continue;if(s.isNameAbbreviation(f,n.slice(T,5)))continue}}E.push(b),b=[],f=0}else{if((v=n[T].indexOf("."))>-1){if(s.isNumber(n[T],v))continue;if(s.isDottedAbbreviation(n[T]))continue;if(s.isURL(n[T])||s.isPhoneNr(n[T]))continue}(w=s.isConcatenated(n[T]))&&(b.pop(),b.push(w[0]),E.push(b),f=0,(b=[]).push(w[1]))}return b.length&&E.push(b),(E=E.filter((function(e){return e.length>0}))).slice(1).reduce((function(e,t){var n=e[e.length-1];return 1===n.length&&/^.{1,2}[.]$/.test(n[0])&&!/[.]/.test(t[0])?(e.pop(),e.push(n.concat(t)),e):(e.push(t),e)}),[E[0]]).map((function(e,t){if(m.preserve_whitespace&&!m.newline_boundaries&&!m.html_boundaries){var n=2*e.length;return 0===t&&(n+=1),u.splice(0,n).join("")}return e.join(" ")}))}},"ckeditor5/src/core.js":(e,t,n)=>{e.exports=n("dll-reference CKEditor5.dll")("./src/core.js")},"ckeditor5/src/ui.js":(e,t,n)=>{e.exports=n("dll-reference CKEditor5.dll")("./src/ui.js")},"ckeditor5/src/utils.js":(e,t,n)=>{e.exports=n("dll-reference CKEditor5.dll")("./src/utils.js")},"ckeditor5/src/widget.js":(e,t,n)=>{e.exports=n("dll-reference CKEditor5.dll")("./src/widget.js")},"dll-reference CKEditor5.dll":e=>{"use strict";e.exports=CKEditor5.dll}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var o={};return(()=>{"use strict";n.d(o,{default:()=>L});var e=n("ckeditor5/src/core.js"),t=n("ckeditor5/src/ui.js");class i{constructor(){}static getInstance(){return i.instance||(i.instance=new i),i.instance}set uiComponent(e){this._uiComponent=e}showError(e){this._uiComponent&&(console.log("Showing error message...",e),this._uiComponent.showGptErrorToolTip(e))}showLoader(e){this._uiComponent&&this._uiComponent.showLoader(e)}hideLoader(){this._uiComponent&&this._uiComponent.hideLoader()}}const s=i.getInstance(),r={"gpt-3.5-turbo":{minOutputTokens:1,maxOutputTokens:4096,maxInputContextTokens:16385},"gpt-4o":{minOutputTokens:0,maxOutputTokens:16384,maxInputContextTokens:128e3},"gpt-4o-mini":{minOutputTokens:1,maxOutputTokens:16384,maxInputContextTokens:128e3},"kavya-m1":{minOutputTokens:0,maxOutputTokens:16384,maxInputContextTokens:128e3}},a=["en","es","hi","nl"],l=["harassment","harassment/threatening","hate","hate/threatening","self-harm","self-harm/instructions","self-harm/intent","sexual","sexual/minors","violence","violence/graphic"],c=[{title:"Edit or review",items:[{title:"Improve Writing",command:"Fix spelling mistakes, use proper grammar and apply good writing practices.\n\t\t\t\t\tDo not lose the original meaning.\nYou must keep the text formatting."},{title:"Make Shorter",command:"Remove any repetitive, redundant, or non-essential writing in this\n\t\t\t\t\tcontent without changing the meaning or losing any key information."},{title:"Make Longer",command:"Improve this content by using descriptive language and inserting\n\t\t\t\t\tmore information and more detailed explanations.\nYou must keep the text formatting."},{title:"Simplify Language",command:"Simplify the writing style of this content and reduce the complexity,\n\t\t\t\t\tso that the content is easy to understand.\nYou must keep the text formatting"}]},{title:"Generate from selection",items:[{title:"Summarize",command:"Summarize this content into one paragraph of text. Include only the key ideas and conclusions.\n\t\t\t\t\tKeep it short. Do not keep original text formatting"},{title:"Continue",command:"Start with the provided content and write at the end of it continuing this topic.\n\t\t\t\t\tKeep the added part short.\nYou must keep the text formatting"}]}];var d=n("ckeditor5/src/widget.js"),u=n("ckeditor5/src/utils.js");const m={blockQuote:"blockquote",caption:"figcaption",codeBlock:"pre",heading1:"h1",heading2:"h2",heading3:"h3",imageBlock:"img",imageInline:"img",paragraph:"p",table:"table",tableCell:"td",tableRow:"tr",$listItem:"li",horizontalLine:"hr"},h={bold:"strong",italic:"em",code:"code",strikethrough:"s",subscript:"sub",superscript:"sup",underline:"u",linkHref:"a"};function p(e){const t=e.model.schema.getDefinitions(),n=Object.keys(t).sort(),o=new Set;n.forEach((e=>{e in m&&o.add(m[e])}));const i=t.$text;return i&&i.allowAttributes&&i.allowAttributes.forEach((e=>{e in h&&o.add(h[e])})),o.has("li")&&(o.add("ul"),o.add("ol")),Array.from(o).sort()}var g=n("./node_modules/sbd/lib/tokenizer.js");function f(e){return e.split("\n").map((e=>e.trim())).join("\n")}function v(e,t,n=!1,o){let i="",s=0;const r={preserve_whitespace:!0,html_boundaries:!0,allowed_tags:p(o)},a=g.sentences(e,r),l=n?a.reverse():a;for(const e of l){const o=e.length;if(!((s+o)/4<=t))break;i=n?e+i:i+e,s+=o}return i.trim()}function w(e){if(!e||"string"!=typeof e)return 0;const t=e.trim().replace(/\s+/g," ").match(/\b\w+('\w+)?\b|[.,!?;:"(){}[\]]/g)||[];let n=0;return t.forEach((e=>{e.length>10?n+=Math.ceil(e.length/4):n+=1})),n}function E(e,t){const n=e.split("\n");let o=0,i="";for(const e of n){const n=w(e);if(o+n>t)break;o+=n,i+=e+"\n"}return i}async function b(e){const t=e.trim();if(!/^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/i.test(t))throw new Error("Invalid URL");try{const e=`https://r.jina.ai/${t.replace(/[^\x20-\x7E]/g,"").trim()}`,n=await fetch(e.trim(),{headers:{"X-With-Generated-Alt":"true"}});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const o=await n.text();if(o.includes("Warning: Target URL returned error"))throw new Error(`Target URL (${t}) returned an error`);if(0===o.trim().length)throw new Error("Empty content received");return o.replace(/\(https?:\/\/[^\s]+\)/g,"").replace(/^\s*$/gm,"").trim()}catch(t){return console.error(`Failed to fetch content: ${e}`,t),s.showError("Failed to fetch URL content"),""}}class T{constructor(e,t={}){var n,o,i,s;this.editor=e;const r=e.config.get("aiAgent");this.contextSize=null!==(n=r.contextSize)&&void 0!==n?n:4e3,this.promptSettings=null!==(o=r.promptSettings)&&void 0!==o?o:{},this.debugMode=null!==(i=r.debugMode)&&void 0!==i&&i,this.editorContextRatio=null!==(s=t.editorContextRatio)&&void 0!==s?s:.3}getSystemPrompt(e=!1){var t,n;const o={responseRules:"\n            Follow these step-by-step instructions to respond to user inputs:\n            Identify the specific requirements from the TASK section.\n            Do not include any markdown syntax in the response.\n            Generate a response that seamlessly integrates with the existing content.\n            Format the response according to the HTML and structural requirements.\n            Verify that the response meets all formatting and content guidelines.\n        ",htmlFormatting:`\n            HTML Formatting Requirements:\n            Generate valid HTML snippets only.\n            Use only the following allowed tags: ${p(this.editor).join(", ")}.\n            Ensure proper tag nesting.\n            Avoid empty elements.\n            Use semantic HTML where appropriate.\n            Maintain clean, readable HTML structure.\n            Follow block-level element rules.\n            Properly close all tags.\n            No inline styles unless specified.\n            No script or style tags.\n            The first word must be a valid HTML tag.\n            Block elements must not contain other block elements.\n        `,contentStructure:"\n            Content Structure Rules:\n            Organize information logically.\n            Use appropriate paragraph breaks.\n            Maintain consistent formatting.\n            Follow document hierarchy.\n            Use appropriate list structures when needed.\n            Ensure proper content flow.\n            Respect existing document structure.\n        ",tone:"\n            Language and Tone Guidelines:\n            Match the formality level of the surrounding content.\n            Maintain a consistent voice throughout the response.\n            Use appropriate technical terminology when relevant.\n            Ensure proper grammar and punctuation.\n            Avoid overly complex sentence structures.\n            Keep the tone engaging and reader-friendly.\n            Adapt style based on content type.\n        ",inlineContent:"\n            Inline Content Specific Rules:\n            Determine content type (list, table, or inline).\n            Format according to content type.\n            Ensure seamless integration.\n            Preserve existing content flow.\n            Maintain proper nesting.\n        ",imageHandling:"\n            Image Element Requirements:\n            Every <img> must have src and alt attributes.\n            Format src URLs as: https://placehold.co/600x400?text=[alt_text].\n            Alt text must be descriptive and meaningful.\n        "};let i="";for(const[s,r]of Object.entries(o)){if("imageHandling"===s&&!p(this.editor).includes("img")||"inlineContent"===s&&!e)continue;const o=s;let a=r;(null===(t=this.promptSettings.overrides)||void 0===t?void 0:t[o])&&(a=this.promptSettings.overrides[o]),(null===(n=this.promptSettings.additions)||void 0===n?void 0:n[o])&&(a+="\n"+this.promptSettings.additions[o]),i+=f(a)+"\n\n"}return this.debugMode&&(console.group("AiAgent System Prompt Debug"),console.log("System Prompt:",i),console.groupEnd()),i}trimContext(e,t=""){var n,o,i,s,r;let a="",l="";const c=null!=t?t:e,d=null===(s=null===(i=null===(o=null===(n=this.editor)||void 0===n?void 0:n.editing)||void 0===o?void 0:o.view)||void 0===i?void 0:i.domRoots)||void 0===s?void 0:s.get("main"),u=null!==(r=null==d?void 0:d.innerText)&&void 0!==r?r:"",m=u.indexOf(c),h=u.indexOf("\n",m),p=-1!==h?h:m+c.length,g=[u.substring(0,p),u.substring(p+1)],f=Math.floor(this.contextSize*this.editorContextRatio);g.length>1&&(g[0].length<g[1].length?(a=v(g[0],f/2,!0,this.editor),l=v(g[1],f-a.length/4,!1,this.editor)):(l=v(g[1],f/2,!1,this.editor),a=v(g[0],f-l.length/4,!0,this.editor)));const w=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");a=a.trim().replace(new RegExp(w.slice(1)),"@@@cursor@@@").replace("/@@@cursor@@@","@@@cursor@@@");return`${a}\n${l}`.trim()}formatFinalPrompt(e,t,n,o){this.debugMode&&(console.group("formatFinalPrompt Debug"),console.log("Request:",e),console.log("Context:",t),console.log("MarkDownContents:",n),console.log("IsEditorEmpty:",o));const i=this.editor.locale.contentLanguage,s=[];if(s.push("<TASK>"),s.push(e),s.push("</TASK>"),(null==t?void 0:t.length)&&(s.push("\n<CONTEXT>"),s.push(t),s.push("</CONTEXT>")),null==n?void 0:n.length){s.push("\n<REFERENCE_CONTENT>");for(const e of n)s.push(`<SOURCE url="${e.url}">\n${e.content}\n</SOURCE>`);s.push("</REFERENCE_CONTENT>"),s.push("\n<REFERENCE_GUIDELINES>"),s.push(f("\n\t\t\t\tUse information from provided markdown to generate new text.\n\t\t\t\tDo not copy content verbatim.\n\t\t\t\tEnsure natural flow with existing context.\n\t\t\t\tAvoid markdown formatting in response.\n\t\t\t\tConsider whole markdown as single source.\n\t\t\t\tGenerate requested percentage of content.\n\t\t\t")),s.push("</REFERENCE_GUIDELINES>")}return s.push("\n<INSTRUCTIONS>"),s.push(`The response must follow the language code - ${i}.`),s.push("</INSTRUCTIONS>"),o||(s.push("\n<CONTEXT_REQUIREMENTS>"),s.push(f('\n\t\t\t\tReplace "@@@cursor@@@" with contextually appropriate content.\n\t\t\t\tReplace ONLY @@@cursor@@@ - surrounding text is READ-ONLY.\n\t\t\t\tNEVER copy or paraphrase context text.\n\t\t\t\tVerify zero phrase duplication.\n\t\t\t\tAnalyze the CONTEXT section thoroughly \n\t\t\t\tto understand the existing content and its style.\n\t\t\t\tGenerate a response that seamlessly integrates \n\t\t\t\twith the existing content.\n\t\t\t\tDetermine the appropriate tone and style based\n\t\t\t\ton the context. Ensure the response flows \n\t\t\t\tnaturally with the existing content.\n\n\t\t\t')),s.push("</CONTEXT_REQUIREMENTS>")),this.debugMode&&(console.group("AiAgent Final Prompt Debug"),console.log("Final Prompt:",s.join("\n")),console.groupEnd()),s.map((e=>function(e){return e.split("\n").map((e=>e.trimStart())).join("\n")}(e))).join("\n")}async generateMarkDownForUrls(e){try{const t=[];for(const n of e)try{const e=await b(n);e&&t.push({content:e,url:n,tokenCount:w(e)})}catch(e){this.debugMode&&console.error(`Failed to fetch content from ${n}:`,e),s.showError(`Failed to fetch content from ${n}`)}return this.allocateTokensToFetchedContent(this.getSystemPrompt(),t)}catch(e){return this.debugMode&&console.error("Error generating markdown content:",e),s.showError("Failed to generate markdown content"),[]}}allocateTokensToFetchedContent(e,t){var n,o,i,s,r,a;const l=null!==(a=null===(r=null===(s=null===(i=null===(o=null===(n=this.editor)||void 0===n?void 0:n.editing)||void 0===o?void 0:o.view)||void 0===i?void 0:i.domRoots)||void 0===s?void 0:s.get("main"))||void 0===r?void 0:r.innerText)&&void 0!==a?a:"",c=Math.min(Math.floor(this.contextSize*this.editorContextRatio),w(l)),d=this.contextSize-c;if(0===d||!t.length)return t;const u=Math.floor(d/t.length);return t.map((e=>({...e,content:E(e.content,u)})))}}class y{constructor(e){var t;this.editor=e,this.model=e.model,this.debugMode=null!==(t=e.config.get("aiAgent.debugMode"))&&void 0!==t&&t}async insertSimpleHtml(e){var t;this.debugMode&&console.log("Attempting to insert simple HTML:",e);const n=this.editor.data.processor.toView(e),o=this.editor.data.toModel(n,"$root"),i=this.model.document.selection,s=this.model.document.getRoot();let r=i.getLastPosition();const a=o.getChild(o.childCount-1),l=null===(t=i.getLastPosition())||void 0===t?void 0:t.path[0],c=null==s?void 0:s.getChild(null!=l?l:0);this.model.change((e=>{if((null==c?void 0:c.is("element"))&&(r=c.isEmpty?e.createPositionAt(c,"end"):e.createPositionAfter(c)),r&&s){e.setSelection(r),this.model.insertContent(o,r);let t=null==a?void 0:a.getAttribute("listItemId");if((null==a?void 0:a.is("element"))&&(t=t||"table"===a.name),t&&a){const t=e.createElement("paragraph");e.insert(t,e.createPositionAfter(a)),e.setSelection(t,"in")}else a&&e.setSelection(e.createPositionAfter(a))}})),await new Promise((e=>setTimeout(e,100)))}async insertAsText(e,t,n=!1,o=!1){const i=this.editor.data.processor.toView(e.outerHTML),s=this.editor.data.toModel(i,"$root"),r=Array.from(s.getChildren()),a=this.model.document.getRoot();for(const[e,o]of r.entries())if(o.is("element")){const i=0===e?t:void 0;n?await this.insertElementAsStream(o,i):await this.batchInsertOfElement(o,i)}o&&this.model.change((e=>{const t=this.model.document.selection.getLastPosition(),n=null==t?void 0:t.path[0];if(a&&null!=n){const t=e.createElement("paragraph");e.insert(t,a,n+1),e.setSelection(t,"in")}}))}async batchInsertOfElement(e,t){var n;const o=this.model.document.selection,i=this.model.document.getRoot();let s=t;if(!t){const e=null===(n=o.getFirstPosition())||void 0===n?void 0:n.path[0],t=null==i?void 0:i.getChild(null!=e?e:0);(null==t?void 0:t.is("element"))&&(s=t.isEmpty?this.model.createPositionAt(t,"end"):this.model.createPositionAfter(t))}this.model.change((t=>{this.model.insertContent(e,s),t.setSelection(e,"end")}))}async insertElementAsStream(e,t){const n=this.model.document.selection,o=this.model.document.getRoot(),i=n.getLastPosition();let s,r=t;if(t){const e=null==i?void 0:i.parent;(null==e?void 0:e.is("element"))&&(s=e)}else{const t=null==i?void 0:i.path[0],n=null==o?void 0:o.getChild(null!=t?t:0);(null==n?void 0:n.is("element"))&&(r=n.isEmpty?this.model.createPositionAt(n,"end"):this.model.createPositionAfter(n)),this.model.change((t=>{s=t.createElement(e.name);for(const[t,n]of e.getAttributes())s._setAttribute(t,n);this.model.insertContent(s,r),r&&t.setSelection(s,"end")}))}const a=Array.from(e.getChildren()).filter((e=>e.is("$text")));for(const e of a){if(!e.is("$text"))continue;const t=Array.from(e.getAttributes()),n=e._data;for(const e of n)await new Promise((n=>{this.model.change((n=>{const o=this.editor.model.document.selection.getLastPosition(),i=o.getShiftedBy(1).offset===(null==o?void 0:o.parent.maxOffset);n.insertText(e,t,s,i?"end":null==o?void 0:o.offset),n.setSelection(this.editor.model.document.selection.getLastPosition())})),setTimeout(n,5)}))}t||this.model.change((e=>{e.setSelection(s,"end")}))}isCompleteHtmlChunk(e){if((e.match(/<[^/][^>]*>/g)||[]).length!==(e.match(/<\/[^>]+>/g)||[]).length)return!1;if(e.includes("<")&&!e.includes(">"))return!1;const t=e.trim();return!(!t.startsWith("<")||!t.endsWith(">"))}}class C{constructor(e){var t,n,o,i,s,r,a,l,c;this.aiAgentFeatureLockId=Symbol("ai-agent-feature"),this.buffer="",this.openTags=[],this.isInlineInsertion=!1,this.abortGeneration=!1,this.disableFlags=[],this.editor=e,this.promptHelper=new T(e),this.htmlParser=new y(e);const d=e.config.get("aiAgent");this.aiModel=d.model,this.apiKey=d.apiKey,this.endpointUrl=d.endpointUrl,this.temperature=d.temperature,this.timeOutDuration=null!==(t=d.timeOutDuration)&&void 0!==t?t:45e3,this.maxTokens=null!==(n=d.maxOutputTokens)&&void 0!==n?n:d.maxTokens,this.retryAttempts=d.retryAttempts,this.stopSequences=d.stopSequences,this.streamContent=null===(o=d.streamContent)||void 0===o||o,this.moderationKey=null!==(s=null===(i=d.moderation)||void 0===i?void 0:i.key)&&void 0!==s?s:"",this.moderationEnable=null!==(a=null===(r=d.moderation)||void 0===r?void 0:r.enable)&&void 0!==a&&a,this.disableFlags=null!==(c=null===(l=d.moderation)||void 0===l?void 0:l.disableFlags)&&void 0!==c?c:[]}async handleSlashCommand(e){const t=this.editor,n=t.model,o=t.editing.mapper,i=t.editing.view,r=n.document.getRoot();let a,l,c,d;const u=n.document.selection.getLastPosition();if(u&&r){d=u.parent;const e="inline-slash"===d.name?d:void 0,s=o.toViewElement(d);if(c=s?i.domConverter.mapViewToDom(s):void 0,e){t.model.change((t=>{const n=t.createPositionAt(e,"end");t.setSelection(n)})),this.isInlineInsertion=!0;const o=t.model.createPositionAt(e,0),r=t.model.createPositionAt(e,"end"),l=n.createRange(o,r);c=(null==s?void 0:s.parent)?i.domConverter.mapViewToDom(s.parent):void 0,a="";for(const e of l.getItems())e.is("$textProxy")&&(a+=e.data.trim())}else c&&(t.model.change((e=>{const t=e.createPositionAt(u.parent,"end");e.setSelection(t)})),a=null==c?void 0:c.innerText)}if(e){a=e,l=null==c?void 0:c.outerHTML;const t=n.document.selection.getFirstRange();t&&n.change((e=>{e.setSelection(t.end)}))}if(this.moderationEnable){if(!await this.moderateContent(null!=a?a:""))return}try{const e=window.getSelection(),t=(null==e?void 0:e.getRangeAt(0)).getBoundingClientRect();s.showLoader(t);const n=await this.generateGptPromptBasedOnUserPrompt(null!=a?a:"",null==c?void 0:c.innerText,l);d&&n&&await this.fetchAndProcessGptResponse(n,d)}catch(e){throw console.error("Error handling slash command:",e),e}finally{this.isInlineInsertion=!1,s.hideLoader()}}async moderateContent(e){var t;if(!this.moderationKey)return!0;const n=this.editor.t,o=new AbortController,i=setTimeout((()=>o.abort()),this.timeOutDuration);try{const r=await fetch("https://api.openai.com/v1/moderations",{method:"POST",headers:{Authorization:`Bearer ${this.moderationKey}`,"Content-Type":"application/json"},body:JSON.stringify({input:e}),signal:o.signal});if(clearTimeout(i),!r.ok)throw new Error(`HTTP error! status: ${r.status}`);const a=await r.json();if(!(null===(t=null==a?void 0:a.results)||void 0===t?void 0:t[0]))throw new Error("Invalid moderation response format");const c=l.filter((e=>!this.disableFlags.includes(e)));if(a.results[0].flagged){let e=!1;const t=a.results[0].categories;for(let n=0;n<c.length;n++){const o=c[n];if(c.includes(o)&&t[o]){e=!0;break}}if(e)return s.showError(n("I'm sorry, but I cannot assist with that request.")),!1}return!0}catch(e){return console.error("Moderation error:",e),e instanceof TypeError?s.showError(n("Network error during content moderation")):e instanceof DOMException&&"AbortError"===e.name?s.showError(n("Content moderation timed out")):s.showError(n("Error in content moderation")),!0}finally{clearTimeout(i)}}async fetchAndProcessGptResponse(e,t,n=this.retryAttempts){var o,i,r;console.log("Starting fetchAndProcessGptResponse");const a=this.editor,l=a.t,c=new AbortController,d=setTimeout((()=>c.abort()),this.timeOutDuration);let u="",m="";const h=`ai-${(new Date).getTime()}`;try{const n=await fetch(this.endpointUrl,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.aiModel,messages:[{role:"system",content:this.promptHelper.getSystemPrompt(this.isInlineInsertion)},{role:"user",content:e}],temperature:this.temperature,max_tokens:this.maxTokens,stop:this.stopSequences,stream:!0}),signal:c.signal});if(clearTimeout(d),!n.ok)throw new Error("Fetch failed");s.hideLoader();const r=n.body.getReader(),l=new TextDecoder("utf-8");this.clearParentContent(t);let p=!0;for(this.cancelGenerationButton(h,c),a.model.change((e=>{var t;const n=a.model.document.selection.getLastPosition();if(n){const o=e.createElement("ai-tag",{id:h}),i=n.parent;i&&("tableCell"===(null===(t=i.parent)||void 0===t?void 0:t.name)||"bulleted"===i.getAttribute("listType"))&&(p=!1);let s="";for(const e of i.getChildren())e.is("$text")&&(s+=e.data);const r=s?e.createPositionAt(n.parent,"after"):e.createPositionAt(n.parent,"before");e.insert(o,p?r:n);const a=e.createPositionAt(o,"end");e.setSelection(a)}})),console.log("Starting to process response");;){const{done:e,value:t}=await r.read();if(e){console.log("Finished reading response");break}let n;for(u+=l.decode(t,{stream:!0});-1!==(n=u.indexOf("\n"));){const e=u.slice(0,n).trim();if(u=u.slice(n+1),e.startsWith("data: ")){const t=e.slice(5).trim();if("[DONE]"===t){console.log("Received [DONE] signal");break}try{const e=null===(i=null===(o=JSON.parse(t).choices[0])||void 0===o?void 0:o.delta)||void 0===i?void 0:i.content;null!=e&&(m+=e),await this.updateContent(m,h)}catch(e){console.warn("Error parsing JSON:",e)}}}}this.processCompleted(h)}catch(o){if(this.abortGeneration)return;console.error("Error in fetchAndProcessGptResponse:",o);const i=((null==o?void 0:o.message)||"").trim()||((null==o?void 0:o.name)||"").trim(),a=["AbortError","ReadableStream not supported","AiAgent: Fetch failed"].includes(i);if(n>0&&a)return console.warn(`Retrying... (${n} attempts left)`),await this.fetchAndProcessGptResponse(e,t,n-1);let c;if("ReadableStream not supported"===((null==o?void 0:o.name)||(null===(r=null==o?void 0:o.message)||void 0===r?void 0:r.trim())))c=l("Browser does not support readable streams");else c=l("We couldn't connect to the AI. Please check your internet");s.showError(c)}finally{this.editor.disableReadOnlyMode(this.aiAgentFeatureLockId)}}cancelGenerationButton(e,n){const o=this.editor,i=o.t,s=new t.ButtonView;let r=i("Cancel Generation");if(u.env.isMac&&(r=i("⌘ + ⌫ Cancel Generation")),u.env.isWindows&&(r=i("Ctrl + ⌫ Cancel Generation")),s.set({label:r,withText:!0,class:"ck-cancel-request-button"}),s.on("execute",(()=>{this.abortGeneration=!0,n.abort(),this.processCompleted(e)})),s.render(),o.keystrokes.set("Ctrl+Backspace",((t,o)=>{(t.ctrlKey||t.metaKey)&&(this.abortGeneration=!0,n.abort(),this.processCompleted(e)),o()})),o.ui.view.element&&s.element){const e=o.ui.view.element.querySelector(".ck-sticky-panel__content .ck-toolbar__items");e&&e.append(s.element)}setTimeout((()=>s.set({class:"ck-cancel-request-button visible"})),2e3)}processCompleted(e){const t=this.editor;if(t.ui.view.element){const e=t.ui.view.element.querySelector(".ck-cancel-request-button");e&&e.remove()}let n=t.getData().replace(/<\/ai-tag>\s*<[^>]+>\s*&nbsp;\s*<\/[^>]+>/g,"");n=n.replace(`<ai-tag id="${e}">`,""),t.setData(n)}getViewChildrens(e,t){const n=[];for(const o of e.getChildren())if(o.is("element"))if(o.is("element","ai-tag")&&o.getAttribute("id")===t)n.push(o);else{const e=this.getViewChildrens(o,t);n.push(...e)}return n}async updateContent(e,t){const n=this.editor;n.model.change((o=>{const i=n.model.document.getRoot();if(i){const s=this.getViewChildrens(i,t),r=s.length?s[0]:null;if(r){const t=n.model.createRangeIn(r);o.remove(t);const i=n.data.processor.toView(e),s=n.data.toModel(i);o.insert(s,r,"end")}}})),await new Promise((e=>setTimeout(e)))}async processContent(e){try{if(console.log("--- Start of processContent ---"),console.log("Processing content:",e,this.isInlineInsertion),this.isInlineInsertion){const t=this.editor.model.document.selection.getLastPosition(),n=document.createElement("div");n.innerHTML=e,await this.htmlParser.insertAsText(n||"",null!=t?t:void 0,this.streamContent)}else this.streamContent?await this.proceedHtmlResponse(e):await this.htmlParser.insertSimpleHtml(e);console.log("--- End of processContent ---")}catch(e){console.error(e)}}async proceedHtmlResponse(e){const t=document.createElement("div");t.innerHTML=e;for(const e of Array.from(t.childNodes)){const t=e;if(t.nodeType===Node.ELEMENT_NODE){const e=t.tagName.toLowerCase();["table","blockquote","pre","img","form","figure"].includes(e)?await this.htmlParser.insertSimpleHtml(t.outerHTML):"ul"===e||"ol"===e?await this.htmlParser.insertAsText(t,void 0,!0,!0):await this.htmlParser.insertAsText(t,void 0,!0)}else if(t.nodeType===Node.TEXT_NODE&&t.textContent){const e=document.createElement("div");e.innerText=t.textContent,await this.htmlParser.insertAsText(e,void 0,!0)}}}clearParentContent(e){const t=this.editor,n=t.model,o=n.document.getRoot(),i=n.document.selection.getLastPosition(),s=Array.from(e.getChildren()).find((e=>"inline-slash"===e.name));o&&i&&t.model.change((t=>{const r=(null==s?void 0:s.getPath())||e.getPath(),a=n.createRange(n.createPositionFromPath(o,r),n.createPositionFromPath(o,i.path));t.remove(a)}))}async generateGptPromptBasedOnUserPrompt(e,t,n){try{const o=this.promptHelper.trimContext(e,t),i=n?e:e.slice(1);let s=[];const r=/https?:\/\/[^\s/$.?#].[^\s]*/g,a=e.match(r);if(Array.isArray(a)&&a.length){const t=a.map((e=>e.replace(/[,.]$/,"")));s=await this.promptHelper.generateMarkDownForUrls(t),s=this.promptHelper.allocateTokensToFetchedContent(e,s)}const l="@@@cursor@@@"===o;return this.promptHelper.formatFinalPrompt(i,o,n,s,l)}catch(e){return console.error(e),null}}}class x extends e.Plugin{constructor(e){var t,n;super(e),this.PLACEHOLDER_TEXT_ID="slash-placeholder",this.GPT_RESPONSE_LOADER_ID="gpt-response-loader",this.GPT_RESPONSE_ERROR_ID="gpt-error",this.showErrorDuration=5e3,this.commandsDropdown=c;const o=e.config.get("aiAgent");this.showErrorDuration=null!==(t=null==o?void 0:o.showErrorDuration)&&void 0!==t?t:5e3,this.commandsDropdown=null!==(n=null==o?void 0:o.commandsDropdown)&&void 0!==n?n:c}static get pluginName(){return"AiAgentUI"}static get requires(){return[d.Widget]}init(){try{s.uiComponent=this,this.initializeUIComponents(),this.initializeUILanguage(),this.attachListener()}catch(e){console.error(e.message)}}initializeUIComponents(){const e=this.editor,t=e.t;e.model.schema.register("inline-slash",{inheritAllFrom:"$block",isInline:!0,isObject:!0,allowWhere:"$text",allowAttributes:["class"]}),e.model.schema.extend("$text",{allowIn:"inline-slash"}),e.conversion.for("upcast").elementToElement({view:{name:"inline-slash",attributes:["class"]},model:(e,{writer:t})=>t.createElement("inline-slash",{class:e.getAttribute("class")}),converterPriority:"high"}),e.conversion.for("downcast").elementToElement({model:{name:"inline-slash",attributes:["class"]},view:(e,{writer:t})=>t.createContainerElement("inline-slash",{class:e.getAttribute("class")})}),this.addPlaceholder(),this.addLoader(),this.addGptErrorToolTip(),this.addAiAgentButton(),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Insert slash command (AI Agent)"),keystroke:"/"}]}),e.model.schema.register("ai-tag",{inheritAllFrom:"$block",isInline:!0,isObject:!0,allowWhere:"$block",allowAttributes:["id"]}),e.model.schema.extend("$block",{allowIn:"ai-tag"}),this.addCustomTagConversions();let n="";u.env.isMac&&(n="Cmd + Backspace"),u.env.isWindows&&(n="Ctrl + Backspace"),e.accessibility.addKeystrokeInfos({keystrokes:[{label:t("Cancel AI Generation"),keystroke:n}]})}addCustomTagConversions(){const e=this.editor;e.conversion.for("upcast").elementToElement({view:{name:"ai-tag",attributes:["id"]},model:(e,{writer:t})=>t.createElement("ai-tag",{id:e.getAttribute("id")})}),e.conversion.for("dataDowncast").elementToElement({model:"ai-tag",view:(e,{writer:t})=>t.createContainerElement("ai-tag",{id:e.getAttribute("id")})}),e.conversion.for("editingDowncast").elementToElement({model:"ai-tag",view:(e,{writer:t})=>{const n=t.createContainerElement("ai-tag",{id:e.getAttribute("id")});return(0,d.toWidget)(n,t)}})}addAiAgentButton(){const e=this.editor.t,n=this.editor.model,o=this.editor.editing.view.document;this.editor.ui.componentFactory.add("aiAgentButton",(i=>{const s=(0,t.createDropdown)(i,t.SplitButtonView);s.class="ck-ai-commands-list";const r=s.buttonView;r.set({label:e("AI Agent"),icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M4.00815 5.01816H19.3851V10.9145H21.1594V3.2439H2.23389V22.1694H12.3955V20.3951H4.00815V5.01816Z" fill="#222330"/>\n    <path d="M15.1908 20.046L20.9028 12.7065L22.9998 14.3385L17.2878 21.678L15.0341 22.755C14.8582 22.8391 14.6619 22.6862 14.7002 22.4951L15.1908 20.046Z" fill="#222330"/>\n    <path d="M16.1211 8.43794V15.7494H14.5753V8.43794H16.1211Z" fill="#222330"/>\n    <path fill-rule="evenodd" clip-rule="evenodd" d="M8.31458 15.7495H6.65807L9.18211 8.43804H11.1742L13.6947 15.7495H12.0382L11.4968 14.0823H8.85696L8.31458 15.7495ZM10.2067 10.1088L11.1051 12.8756H9.24951L10.1496 10.1088H10.2067Z" fill="#222330"/>\n</svg>',tooltip:!0}),r.on("execute",(()=>{this.editor.model.change((e=>{const t=this.editor.model.document.selection.getLastPosition();if(t){const n=e.createElement("inline-slash",{class:"ck-slash"});e.insertText("/",n),e.insert(n,t);const o=e.createPositionAt(n,"end");e.setSelection(o)}})),this.editor.editing.view.focus()}));const a=new t.MenuBarMenuView(i),l=new t.MenuBarMenuListView(i),c=new t.MenuBarMenuListItemView(i,a),d=new t.LabeledFieldView(i,t.createLabeledInputText);d.label=e("Search AI command");const u=document.createElement("div");u.className="ck-input-icon-wrapper";const m=document.createElement("span");m.className="ck-input-search-icon",m.innerHTML='<svg class="svg-icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M679.039688 749.379825a29.25665 29.25665 0 0 1 46.225506-35.927166l204.796548 263.309847a29.25665 29.25665 0 0 1-46.225507 35.927166l-204.796547-263.309847zM482.727568 789.929541C264.589988 789.929541 87.762798 613.102351 87.762798 394.964771S264.589988 0 482.727568 0 877.692339 176.827191 877.692339 394.964771 700.865148 789.929541 482.727568 789.929541z m0-58.513299C668.53655 731.416242 819.17904 580.773753 819.17904 394.964771S668.53655 58.513299 482.727568 58.513299 146.276097 209.155789 146.276097 394.964771 296.918586 731.416242 482.727568 731.416242z" fill="#7F7F7F" /></svg>',u.appendChild(m),d.fieldView.on("input",(()=>{var e;if(null===(e=null==d?void 0:d.fieldView)||void 0===e?void 0:e.element){const e=d.fieldView.element.value.toLowerCase();this.aiAgentListItemUpdate(l,"search",e)}})),o.on("selectionChange",(()=>{const e=n.document.selection.getFirstRange();if(e){const t=!!Array.from(e.getItems()).map((e=>e.data)).join("");this.aiAgentListItemUpdate(l,"enable",t)}})),c.children.add(d),l.items.add(c),d.element&&d.element.appendChild(u);for(const n of this.commandsDropdown){const o=new t.ListSeparatorView(i);l.items.add(o);const s=new t.MenuBarMenuListItemView(i,a),r=new t.MenuBarMenuListItemButtonView(i);r.set({label:e(n.title),class:"ck-menu-group-title",isEnabled:!1}),s.children.add(r),l.items.add(s);for(const o of n.items){const n=new t.MenuBarMenuListItemView(i,a),s=new t.MenuBarMenuListItemButtonView(i);s.set({label:e(o.title),class:"ck-menu-item",isEnabled:!1}),s.delegate("execute").to(a),s.on("execute",(()=>{const e=new C(this.editor);this.editor.editing.view.focus(),e.handleSlashCommand(o.command)})),n.children.add(s),l.items.add(n)}}return s.panelView.children.add(l),s}))}aiAgentListItemUpdate(e,t,n){e.items.map((e=>{var o;const i=e;if(null===(o=i.children)||void 0===o?void 0:o.first){const e=i.children.first;if(e.class){const o=e.class.includes("ck-menu-group-title"),s=e.class.includes("ck-ai-search-input"),r=!e.label;if(!o&&!r&&!s){const o=e.label.toLowerCase();"search"===t&&(i.isVisible=!n||o.includes(n)),"enable"===t&&(i.isEnabled=n,e.isEnabled=n)}}}}))}initializeUILanguage(){const e=this.editor,t=e.t,n=e.locale.contentLanguage;a.includes(n)||this.showGptErrorToolTip(t("Unsupported language code"))}attachListener(){const e=this.editor,t=e.model;t.document.on("change:data",(()=>{setTimeout((()=>{this.applyPlaceholderToCurrentLine()}),10)})),t.document.selection.on("change:range",(()=>{setTimeout((()=>{this.applyPlaceholderToCurrentLine()}),10);const t=e.model.document.getRoot();if(t){const n=e.model.createRangeIn(t),o=[];for(const e of n.getItems())e.is("element","inline-slash")&&e.isEmpty&&o.push(e);e.model.change((e=>{for(const t of o)e.remove(t)}))}})),e.editing.view.document.on("scroll",(()=>{this.hidePlaceHolder()})),document.addEventListener("scroll",(()=>{this.hidePlaceHolder()}))}applyPlaceholderToCurrentLine(){var e;const t=null===(e=this.editor.model.document.selection.getFirstPosition())||void 0===e?void 0:e.parent;t&&t.isEmpty?(this.hidePlaceHolder(),setTimeout((async()=>{if(t.is("element")){const e=await this.getRectDomOfGivenModelElement(t);e&&this.showPlaceHolder(e)}}),100)):this.hidePlaceHolder()}async getRectDomOfGivenModelElement(e){const t=this.editor,n=t.editing.mapper,o=t.editing.view,i=n.toViewElement(e);if(i){const e=o.domConverter.mapViewToDom(i);if(e)return e.getBoundingClientRect()}return null}addPlaceholder(){const e=this.editor,t=e.t,n=document.createElement("p");n.id=this.PLACEHOLDER_TEXT_ID,n.onclick=()=>{e.focus()},n.classList.add("place-holder"),n.textContent=t("Type / to request AI content"),setTimeout((async()=>{const t=e.ui.view.element;t&&t.append(n)}))}showPlaceHolder(e){var t;const n=null===(t=this.editor.ui.view.element)||void 0===t?void 0:t.querySelector(`#${this.PLACEHOLDER_TEXT_ID}`),o=this.editor.isReadOnly;n&&e&&!o?(n.classList.add("show-place-holder"),n.style.left=`${e.left}px`,n.style.top=`${e.top}px`):n&&n.classList.remove("show-place-holder")}hidePlaceHolder(){var e;const t=null===(e=this.editor.ui.view.element)||void 0===e?void 0:e.querySelector(`#${this.PLACEHOLDER_TEXT_ID}`);t&&t.classList.remove("show-place-holder")}addLoader(){const e=document.createElement("div");e.id=this.GPT_RESPONSE_LOADER_ID,e.classList.add("gpt-loader"),document.body.appendChild(e)}showLoader(e){const t=document.getElementById(this.GPT_RESPONSE_LOADER_ID);t&&e?(t.style.left=`${e.left+10}px`,t.style.top=`${e.top+10}px`,t.classList.add("show-gpt-loader")):t&&t.classList.remove("show-gpt-loader")}hideLoader(){const e=document.getElementById(this.GPT_RESPONSE_LOADER_ID);e&&e.classList.remove("show-gpt-loader")}addGptErrorToolTip(){const e=document.createElement("p");e.id=this.GPT_RESPONSE_ERROR_ID,e.classList.add("response-error"),document.body.appendChild(e)}showGptErrorToolTip(e){var t,n,o;console.log("Showing error message...",e);const i=this.editor,s=null===(o=null===(n=null===(t=null==i?void 0:i.editing)||void 0===t?void 0:t.view)||void 0===n?void 0:n.domRoots)||void 0===o?void 0:o.get("main"),r=document.getElementById(this.GPT_RESPONSE_ERROR_ID),a=null==s?void 0:s.getBoundingClientRect();r&&a&&(r.classList.add("show-response-error"),r.textContent=e,setTimeout((()=>{this.hideGptErrorToolTip()}),this.showErrorDuration))}hideGptErrorToolTip(){const e=document.getElementById(this.GPT_RESPONSE_ERROR_ID);e&&e.classList.remove("show-response-error")}}class A extends e.Command{constructor(e,t){super(e),this.aiAgentService=t}refresh(){this.isEnabled=!0}async execute(){await this.aiAgentService.handleSlashCommand()}}class k extends e.Plugin{static get pluginName(){return"AiAgentEditing"}init(){const e=this.editor,t=new C(e);e.commands.add("aiAgent",new A(e,t)),this.setupEnterKeyHandling()}setupEnterKeyHandling(){const e=this.editor,t=e.model,n=e.editing.mapper,o=e.editing.view;e.keystrokes.set("enter",(async(i,s)=>{var r;const a=t.document.selection.getFirstPosition();if(a){const t=a.parent,i=Array.from(t.getChildren()).find((e=>"inline-slash"===e.name)),l=n.toViewElement(t);let c;l&&(c=null===(r=o.domConverter.mapViewToDom(l))||void 0===r?void 0:r.innerText),("string"==typeof c&&c.startsWith("/")||i)&&(s(),await e.execute("aiAgent"))}}))}}class S extends e.Plugin{constructor(e){super(e),this.DEFAULT_GPT_MODEL="gpt-4o",this.DEFAULT_AI_END_POINT="https://api.openai.com/v1/chat/completions";const t=e.config.get("aiAgent")||{},n={...{model:this.DEFAULT_GPT_MODEL,apiKey:"",endpointUrl:this.DEFAULT_AI_END_POINT,temperature:.7,timeOutDuration:45e3,maxOutputTokens:r[this.DEFAULT_GPT_MODEL].maxOutputTokens,maxInputTokens:r[this.DEFAULT_GPT_MODEL].maxInputContextTokens,retryAttempts:1,contextSize:.75*r[this.DEFAULT_GPT_MODEL].maxInputContextTokens,stopSequences:[],promptSettings:{},debugMode:!1,streamContent:!0},...t};e.config.set("aiAgent",n),this.validateConfiguration(n)}static get requires(){return[x,k]}static get pluginName(){return"AiAgent"}validateConfiguration(e){if(!e.apiKey)throw new Error("AiAgent: apiKey is required.");if(e.temperature&&(e.temperature<0||e.temperature>2))throw new Error("AiAgent: Temperature must be a number between 0 and 2.");const t=r[e.model];if(void 0!==e.maxOutputTokens&&(e.maxOutputTokens<t.minOutputTokens||e.maxOutputTokens>t.maxOutputTokens))throw new Error(`AiAgent: maxOutputTokens must be between ${t.minOutputTokens} and ${t.maxOutputTokens} for ${e.model}`);if(void 0!==e.maxInputTokens&&e.maxInputTokens>t.maxInputContextTokens)throw new Error(`AiAgent: maxInputTokens cannot exceed ${t.maxInputContextTokens} for ${e.model}`)}init(){}}const L={AiAgent:S}})(),o=o.default})()));